<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Nutri-Lite CRM (å®‰å…¨ç™»å½•ç‰ˆ)</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f4f7f6; }
        .container { max-width: 600px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; text-align: center; }
        .input-group { display: flex; gap: 10px; margin-bottom: 25px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; outline: none; }
        button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        #mainBtn { background: #28a745; color: white; }
        #mainBtn.btn-update { background: #ffc107; color: #333; }
        .product-card { border-bottom: 1px solid #eee; padding: 15px 0; display: flex; justify-content: space-between; align-items: center; }
        .actions { display: flex; gap: 8px; }
        .btn-del { background: #dc3545; color: white; font-size: 12px; }
        .btn-edit { background: #007bff; color: white; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Nutri-Lite äº§å“ç®¡ç†</h1>
        
        <div class="input-group">
            <input type="text" id="pName" placeholder="äº§å“å“å">
            <input type="number" id="pPrice" placeholder="å•ä»· (USD)">
            <button id="mainBtn" onclick="handleAction()">æäº¤åˆ°ä»“åº“</button>
        </div>

        <div id="displayArea">æ­£åœ¨ä»äº‘ç«¯æ‹‰å–æ•°æ®...</div>
    </div>

    <script>
        // 1. é…ç½®åŒºåŸŸ
        // âš ï¸ è¯·ç¡®ä¿è¿™é‡Œæ˜¯å¸¦ https:// çš„å®Œæ•´ Railway é“¾æ¥
        const API_URL = "https://nutri-lite-production.up.railway.app"; 
        
        let currentEditId = null;

        // 2. ç™»å½•ä¿æŠ¤é€»è¾‘
        let userPassword = localStorage.getItem('crm_password'); 

        if (!userPassword) {
            userPassword = prompt("è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥å¼€å¯ç¼–è¾‘åŠŸèƒ½ï¼š");
            if (userPassword) {
                localStorage.setItem('crm_password', userPassword);
            }
        }

        // 3. è·å–åˆ—è¡¨ (GET) - é€šå¸¸ä¸éœ€è¦å¯†ç ï¼Œæ–¹ä¾¿æŸ¥çœ‹
        async function refreshList() {
            try {
                const res = await fetch(`${API_URL}/products`);
                if (!res.ok) throw new Error("æœåŠ¡å™¨å“åº”å¤±è´¥");
                const data = await res.json();
                document.getElementById('displayArea').innerHTML = data.map(item => `
                    <div class="product-card">
                        <div><strong>${item.name}</strong> - $${item.price}/MT</div>
                        <div class="actions">
                            <button class="btn-edit" onclick="startEdit(${item.id}, '${item.name}', ${item.price})">ç¼–è¾‘</button>
                            <button class="btn-del" onclick="deleteProduct(${item.id})">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                document.getElementById('displayArea').innerHTML = "æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ Railway çŠ¶æ€ã€‚";
                console.error(err);
            }
        }

        // 4. å‡†å¤‡ç¼–è¾‘
        function startEdit(id, name, price) {
            currentEditId = id;
            document.getElementById('pName').value = name;
            document.getElementById('pPrice').value = price;
            const btn = document.getElementById('mainBtn');
            btn.innerText = "ä¿å­˜ä¿®æ”¹";
            btn.classList.add("btn-update");
        }

        // 5. æäº¤æˆ–æ›´æ–° (POST / PUT) - ğŸ” éœ€è¦å¯†ç æ ¡éªŒ
        async function handleAction() {
            const name = document.getElementById('pName').value;
            const price = document.getElementById('pPrice').value;
            if (!name || !price) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");

            const method = currentEditId ? 'PUT' : 'POST';
            const url = currentEditId ? `${API_URL}/products/${currentEditId}` : `${API_URL}/products`;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': userPassword  // ğŸ‘ˆ åœ¨è¿™é‡Œå¡å…¥å¯†ç 
                    },
                    body: JSON.stringify({ name, price })
                });

                if (response.ok) {
                    currentEditId = null;
                    document.getElementById('pName').value = "";
                    document.getElementById('pPrice').value = "";
                    const btn = document.getElementById('mainBtn');
                    btn.innerText = "æäº¤åˆ°ä»“åº“";
                    btn.classList.remove("btn-update");
                    refreshList();
                } else if (response.status === 401) {
                    alert("ğŸš« èº«ä»½éªŒè¯å¤±è´¥ï¼šå¯†ç é”™è¯¯ï¼");
                    localStorage.removeItem('crm_password'); // æ¸…é™¤é”™è¯¯å¯†ç 
                    location.reload(); // åˆ·æ–°é¡µé¢é‡æ–°è¾“å…¥
                } else {
                    alert("æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æŠ¥é”™");
                }
            } catch (err) {
                alert("ç½‘ç»œè¿æ¥é”™è¯¯");
            }
        }

        // 6. åˆ é™¤é€»è¾‘ (DELETE) - ğŸ” éœ€è¦å¯†ç æ ¡éªŒ
        async function deleteProduct(id) {
            if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡äº§å“ä¿¡æ¯å—ï¼Ÿ")) return;

            try {
                const response = await fetch(`${API_URL}/products/${id}`, { 
                    method: 'DELETE',
                    headers: { 'Authorization': userPassword } // ğŸ‘ˆ åˆ é™¤ä¹Ÿéœ€è¦å¯†ç 
                });

                if (response.ok) {
                    refreshList();
                } else {
                    alert("åˆ é™¤å¤±è´¥ï¼Œå¯èƒ½æ˜¯å¯†ç é”™è¯¯");
                }
            } catch (err) {
                alert("ç½‘ç»œé”™è¯¯");
            }
        }

        // 7. åˆå§‹åŒ–åŠ è½½
        refreshList();
    </script>
</body>
</html>